<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout.html}">
<section class="row" layout:fragment="content">

<head>
    <meta charset="utf-8">
    <title>Lịch sử mua hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Popup styles với prefix "custom-" để tránh trùng lặp */
        .custom-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Tông nền tối hơn */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .custom-popup-content {
            background-color: #fff; /* Nền trắng */
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            width: 400px;
            text-align: center;
        }

        .custom-popup-label {
            color: #FF0000; /* Tiêu đề màu đỏ */
            margin-bottom: 20px;
        }

        .custom-form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .custom-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333; /* Màu chữ tối hơn cho nhãn */
        }

        .custom-form-group input,
        .custom-form-group textarea {
            width: 100%;
            padding: 8px;
            margin-top: 3px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            color: #333;
        }

        .custom-form-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        .custom-form-group textarea {
            resize: none;
        }

        .custom-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .custom-btn-primary {
            background-color: #FF0000; /* Nút chính màu đỏ */
            color: #fff;
            transition: background-color 0.3s ease;
        }

        .custom-btn-primary:hover {
            background-color: #cc0000; /* Màu đỏ đậm hơn khi hover */
        }

        .custom-btn-secondary {
            background-color: #333; /* Nút đóng màu đen/xám */
            color: #fff;
            margin-left: 10px;
            transition: background-color 0.3s ease;
        }

        .custom-btn-secondary:hover {
            background-color: #555; /* Màu xám sáng hơn khi hover */
        }

        .custom-form-actions {
            margin-top: 20px;
        }

        .custom-form-group input::placeholder {
            color: #999; /* Placeholder màu xám nhạt */
        }

    </style>
</head>

<body>
        <!-- breadcrumb area start -->
        <div class="breadcrumb-area">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="breadcrumb-wrap">
                            <nav aria-label="breadcrumb">
                                <ul class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">my account</li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- breadcrumb area end -->

        <!-- my account wrapper start -->
        <div class="my-account-wrapper">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <!-- My Account Page Start -->
                        <div class="myaccount-page-wrapper">
                            <!-- My Account Tab Menu Start -->
                            <div class="row">
                                <div class="col-lg-3 col-md-4">
                                    <div class="myaccount-tab-menu nav" role="tablist">
                                        <a href="#dashboad" class="active" data-toggle="tab"><i class="fa fa-dashboard"></i>
                                            Dashboard</a>
                                        <a href="#orders" data-toggle="tab"><i class="fa fa-cart-arrow-down"></i> Orders</a>
                                        <a href="#download" data-toggle="tab"><i class="fa fa-cloud-download"></i> Download</a>
                                        <a href="#payment-method" data-toggle="tab"><i class="fa fa-credit-card"></i> Payment
                                            Method</a>
                                        <a href="#address-edit" data-toggle="tab"><i class="fa fa-map-marker"></i> address</a>
                                        <a href="#account-info" data-toggle="tab"><i class="fa fa-user"></i> Account Details</a>
                                        <a href="login.html"><i class="fa fa-sign-out"></i> Logout</a>
                                    </div>
                                </div>
                                <!-- My Account Tab Menu End -->
        
                                <!-- My Account Tab Content Start -->
                                <div class="col-lg-9 col-md-8">
                                    <div class="tab-content" id="myaccountContent">
                                        <!-- Single Tab Content Start -->
                                        <div class="tab-pane fade show active" id="dashboad" role="tabpanel">
                                            <div class="myaccount-content">
                                                <h3>Dashboard</h3>
                                                <div class="welcome">
                                                    <p>Hello, <strong>Alex Tuntuni</strong> (If Not <strong>Tuntuni !</strong><a href="login.html" class="logout"> Logout</a>)</p>
                                                </div>
                                                <p class="mb-0">From your account dashboard. you can easily check & view your recent orders, manage your shipping and billing addresses and edit your password and account details.</p>
                                            </div>
                                        </div>
                                        <!-- Single Tab Content End -->

                                        <!-- Single Tab Content Start -->
                                        <div class="tab-pane fade" id="orders" role="tabpanel">
                                            <div class="myaccount-content">
                                                <h3>Orders</h3>
                                                <div class="myaccount-table table-responsive text-center">
                                                    <table class="table table-bordered">
                                                        <thead class="thead-light">
                                                        <tr>
                                                            <th>Mã đơn hàng</th>
                                                            <th>Sản phẩm</th>
                                                            <th>Số lượng</th>
                                                            <th>Ngày đặt</th>
                                                            <th>Trạng thái</th>
<!--                                                            <th>Tổng tiền</th>-->

                                                            <th>Action</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        <tr th:each="order : ${orders}">
                                                            <td th:text="${order.orderId}"></td>
                                                            <td>
                                                                <ul>
                                                                    <li th:each="lineItem : ${order.listLineItems}">
                                                                        <span th:text="${lineItem.product.name}"></span>
                                                                    </li>
                                                                </ul>
                                                            </td>
                                                            <td>
                                                                <ul>
                                                                    <li th:each="lineItem : ${order.listLineItems}">
                                                                        <span th:text="${lineItem.quantity}"></span>
                                                                    </li>
                                                                </ul>
                                                            </td>
                                                            <td th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy')}"></td>
                                                            <td th:text="${order.shippingStatus}"></td>
<!--                                                            <td th:text="${order.getTotalOrderValue()}"></td>-->
                                                            <td>
                                                                <a th:href="@{/purchase/details(orderId=${order.orderId})}" class="btn btn-info btn-sm">Xem chi tiết</a>
                                                                <button th:data-order-id="${order.orderId}" onclick="checkOrderStatus(this)" class="btn btn-danger btn-sm">Hủy đơn hàng</button>
                                                            </td>
                                                        </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Single Tab Content End -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
<!--    popup cancel order-->
        <div id="cannotCancelPopup" class="custom-popup" style="display: none;">
            <div class="custom-popup-content">
                <h3 class="custom-popup-label">Không thể hủy đơn hàng</h3>
                <p>Đơn hàng đã được vận chuyển, bạn không thể hủy đơn hàng này.</p>
                <button type="button" class="custom-btn custom-btn-secondary" onclick="closeCannotCancelPopup()">Đóng</button>
            </div>
        </div>
        <div id="cancelOrderPopup" class="custom-popup" style="display: none;">
            <div class="custom-popup-content">
                <h3 class="custom-popup-label">Xác nhận hủy đơn hàng</h3>
                <form id="cancelOrderForm" th:action="@{/history/cancel}" method="post">
                    <input type="hidden" id="popupOrderId" name="orderId" />

                    <div class="custom-form-group">
                        <label for="accountNumber">Số tài khoản</label>
                        <input type="text" id="accountNumber" name="accountNumber" required placeholder="Nhập số tài khoản" />
                    </div>

                    <div class="custom-form-group">
                        <label for="accountName">Tên người nhận</label>
                        <input type="text" id="accountName" name="accountName" required placeholder="Nhập tên người nhận" />
                    </div>

                    <div class="custom-form-group">
                        <label for="bankName">Ngân hàng</label>
                        <input type="text" id="bankName" name="bankName" required placeholder="Nhập tên ngân hàng" />
                    </div>

                    <div class="custom-form-actions">
                        <button type="submit" class="custom-btn custom-btn-primary">Xác nhận hủy</button>
                        <button type="button" class="custom-btn custom-btn-secondary" onclick="closeCancelOrderPopup()">Đóng</button>
                    </div>
                </form>
            </div>
        </div>
        <script>
            function checkOrderStatus(button) {
                // Lấy ID đơn hàng từ thuộc tính data-order-id
                const orderId = button.getAttribute("data-order-id");

                // Gọi API kiểm tra trạng thái đơn hàng
                fetch(`/status/${orderId}`)
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.status === "SHIPPED") {
                            // Nếu đơn hàng đã được vận chuyển, hiển thị popup thông báo không thể hủy
                            openCannotCancelPopup();
                        } else {
                            // Nếu đơn hàng chưa được vận chuyển, hiển thị popup hủy đơn hàng
                            document.getElementById("popupOrderId").value = orderId;
                            openCancelOrderPopup();
                        }
                    })
                    .catch((error) => {
                        console.error("Error fetching order status:", error);
                        alert("Có lỗi xảy ra, vui lòng thử lại sau.");
                    });
            }

            function openCannotCancelPopup() {
                document.getElementById("cannotCancelPopup").style.display = "flex";
            }

            function closeCannotCancelPopup() {
                document.getElementById("cannotCancelPopup").style.display = "none";
            }

            function openCancelOrderPopup() {
                document.getElementById("cancelOrderPopup").style.display = "flex";
            }

            function closeCancelOrderPopup() {
                document.getElementById("cancelOrderPopup").style.display = "none";
            }
        </script>
</body>
</section>

</html>